From da525f642d978eac769445cd1e8693022b22a908 Mon Sep 17 00:00:00 2001
From: Joshua Strobl <joshua@stroblindustries.com>
Date: Sat, 13 Apr 2019 15:14:58 +0300
Subject: [PATCH 1/1] modules: Use stateless configuration for im-multipress

---
 modules/input/Makefile.am              |  4 ++--
 modules/input/gtkimcontextmultipress.c | 17 ++++++++++++-----
 2 files changed, 14 insertions(+), 7 deletions(-)

diff --git a/modules/input/Makefile.am b/modules/input/Makefile.am
index ce39463..c826d42 100644
--- a/modules/input/Makefile.am
+++ b/modules/input/Makefile.am
@@ -208,7 +208,7 @@ WAYLANDGTK_MODULE = im-waylandgtk.la
 endif
 endif
 
-multipress_defs = -DMULTIPRESS_LOCALEDIR=\""$(mplocaledir)"\" -DMULTIPRESS_CONFDIR=\""$(sysconfdir)/gtk-3.0"\"
+multipress_defs = -DMULTIPRESS_LOCALEDIR=\""$(mplocaledir)"\" -DMULTIPRESS_CONFDIR=\""$(sysconfdir)/gtk-2.0"\" -DSYSTEM_MULTIPRESS_CONFDIR=\""$(datadir)/gtk-3.0"\"
 im_multipress_la_CPPFLAGS = $(AM_CPPFLAGS) $(multipress_defs)
 libstatic_im_multipress_la_CPPFLAGS = $(im_multipress_la_CPPFLAGS)
 im_multipress_la_LDFLAGS = -rpath $(moduledir) -avoid-version -module $(no_undefined)
@@ -224,7 +224,7 @@ else
 MULTIPRESS_MODULE = im-multipress.la
 endif
 
-imconffiledir = $(sysconfdir)/gtk-3.0
+imconffiledir = $(datadir)/gtk-3.0
 dist_imconffile_DATA = im-multipress.conf
 
 if CROSS_COMPILING
diff --git a/modules/input/gtkimcontextmultipress.c b/modules/input/gtkimcontextmultipress.c
index b92570b..bd27bf4 100644
--- a/modules/input/gtkimcontextmultipress.c
+++ b/modules/input/gtkimcontextmultipress.c
@@ -25,6 +25,7 @@
 
 #define AUTOMATIC_COMPOSE_TIMEOUT 1 /* seconds */
 #define CONFIGURATION_FILENAME MULTIPRESS_CONFDIR G_DIR_SEPARATOR_S "im-multipress.conf"
+#define STATELESS_CONFIGURATION_FILENAME SYSTEM_MULTIPRESS_CONFDIR G_DIR_SEPARATOR_S "im-multipress.conf"
 
 /* This contains rows of characters that can be entered by pressing
  * a particular key repeatedly.  Each row has one key (such as GDK_a),
@@ -384,12 +385,18 @@ load_config (GtkImContextMultipress *self)
   gsize     i;
 
   key_file = g_key_file_new ();
+  const char *conf_filename = NULL;
 
-  if (!g_key_file_load_from_file (key_file, CONFIGURATION_FILENAME,
+  if (g_file_test(CONFIGURATION_FILENAME, G_FILE_TEST_EXISTS))
+    conf_filename = CONFIGURATION_FILENAME;
+  else
+    conf_filename = STATELESS_CONFIGURATION_FILENAME;
+
+  if (!g_key_file_load_from_file (key_file, conf_filename,
                                   G_KEY_FILE_NONE, &error))
     {
       g_warning ("Error while trying to open the %s configuration file: %s",
-                 CONFIGURATION_FILENAME, error->message);
+                 conf_filename, error->message);
       g_error_free (error);
       g_key_file_free (key_file);
       return;
@@ -400,7 +407,7 @@ load_config (GtkImContextMultipress *self)
   if (error != NULL)
     {
       g_warning ("Error while trying to read the %s configuration file: %s",
-                 CONFIGURATION_FILENAME, error->message);
+                 conf_filename, error->message);
       g_error_free (error);
       g_key_file_free (key_file);
       return;
@@ -417,7 +424,7 @@ load_config (GtkImContextMultipress *self)
         {
           g_warning ("Error while trying to read the %s configuration file: "
                      "invalid key name \"%s\"",
-                     CONFIGURATION_FILENAME, keys[i]);
+                     conf_filename, error->message);
           continue;
         }
 
@@ -427,7 +434,7 @@ load_config (GtkImContextMultipress *self)
       if (error != NULL)
         {
           g_warning ("Error while trying to read the %s configuration file: %s",
-                     CONFIGURATION_FILENAME, error->message);
+                     conf_filename, error->message);
           g_error_free (error);
           error = NULL;
           g_slice_free (KeySequence, seq);
-- 
2.21.0

